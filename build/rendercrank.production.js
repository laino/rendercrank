!function(t,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.RenderCrank=r():t.RenderCrank=r()}(self,(function(){return(()=>{"use strict";var t={d:(r,e)=>{for(var n in e)t.o(e,n)&&!t.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:e[n]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};t.r(r),t.d(r,{ArrayBufferProtocolReader:()=>U,ArrayBufferProtocolWriter:()=>R,Buffer:()=>D,BufferRef:()=>S,COMMAND_MAP:()=>e,CanvasRenderer:()=>v,Command:()=>n,Component:()=>J,DrawCallBatcher:()=>F,Instruction:()=>s,Instructor:()=>w,Program:()=>P,ProgramRef:()=>x,ProtocolReader:()=>m,ProtocolWriter:()=>A,RESOURCE_MAP:()=>i,RenderContext:()=>W,RenderContextID:()=>N,RenderTarget:()=>j,Resource:()=>h,ResourceID:()=>f,ResourceRef:()=>c,ResourceState:()=>o,RunProgram:()=>V,SingleThreadedCanvasRenderer:()=>X,registerResourceType:()=>a});var e={};function n(t){if(Object.prototype.hasOwnProperty.call(e,t.name))throw new Error("A command with the name "+t.name+" is already registered.");return e[t.name]=t,t}var o,i={};function a(t){var r=t.resourceName;if("Resource"===r)throw new Error('Resource name can\'t be "Resource".');if(Object.prototype.hasOwnProperty.call(i,r))throw new Error("A resource type with the name "+r+" is already registered.");i[r]=t}!function(t){t[t.UNLOADED=0]="UNLOADED",t[t.LOADING=1]="LOADING",t[t.LOAD_ABORTED=2]="LOAD_ABORTED",t[t.LOADED=3]="LOADED",t[t.READY=4]="READY"}(o||(o={}));var f,u=0;!function(t){t.nextID=function(){return u++}}(f||(f={}));var s,c=function(){function t(t){this.type=t,this.id=f.nextID(),this.state=o.UNLOADED,this.refcount=0,this.needsUpdate=!1}return t.prototype.load=function(){},t.prototype.writeData=function(t){},t.prototype.writeUpdate=function(t){},t.prototype.onUnload=function(){this.needsUpdate=!1},t}(),h=function(){function t(t){this.renderer=t}return t.resourceName="Resource",t}(),l=function(t){var r="function"==typeof Symbol&&Symbol.iterator,e=r&&t[r],n=0;if(e)return e.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},p=function(t,r){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var n,o,i=e.call(t),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(o)throw o.error}}return a},d=function(t,r){for(var e=0,n=r.length,o=t.length;e<n;e++,o++)t[o]=r[e];return t};!function(t){t[t.STOP=0]="STOP",t[t.RUN_COMMAND=1]="RUN_COMMAND",t[t.MAP_COMMAND=2]="MAP_COMMAND",t[t.UPDATE_RESOURCE=3]="UPDATE_RESOURCE",t[t.LOAD_RESOURCE=4]="LOAD_RESOURCE",t[t.UNLOAD_RESOURCE=5]="UNLOAD_RESOURCE",t[t.ADVANCE=6]="ADVANCE"}(s||(s={}));var y,w=function(){function t(t){var r,n;this.protocol=t,this.mappedCommands={},this.resources=new Set;var o=0;try{for(var i=l(Object.values(e)),a=i.next();!a.done;a=i.next()){var f=a.value;t.writeUInt8(s.MAP_COMMAND),t.writeUInt8(o),t.writeString(f.name),this.mappedCommands[f.name]=o,o++}}catch(t){r={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}this.commandProtocol=t.createWriter()}return t.prototype.command=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];var n=this.commandProtocol;n.writeUInt8(s.RUN_COMMAND),t.submit.apply(t,d([this,n],p(r)))},t.prototype.finish=function(){var t,r;this.commandProtocol.writeUInt8(s.STOP);var e=this.commandProtocol.flush(),n=this.protocol;n.writeUInt8(s.ADVANCE),n.advance();try{for(var o=l(e),i=o.next();!i.done;i=o.next()){var a=i.value;n.passData(a)}}catch(r){t={error:r}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}},t.prototype.loadResource=function(t){var r=this.protocol;if(this.resources.add(t),t.state!==o.LOAD_ABORTED){if(t.state===o.UNLOADED){t.state=o.LOADING;var e=t.load();if(e)return void e.then((function(){t.state===o.LOAD_ABORTED?(t.onUnload(),t.state=o.UNLOADED):t.state=o.LOADED}));t.state=o.LOADED}t.state===o.LOADED&&(r.writeUInt8(s.LOAD_RESOURCE),r.writeUInt32(t.id),r.writeString(t.type.resourceName),t.writeData(r),t.state=o.READY),t.state===o.READY&&t.needsUpdate&&(t.needsUpdate=!1,r.writeUInt8(s.UPDATE_RESOURCE),r.writeUInt32(t.id),t.writeUpdate(r))}else t.state=o.LOADING},t.prototype.unloadResource=function(t){var r=this.protocol;t.refcount>0||t.state===o.UNLOADED||(t.state===o.READY&&(r.writeUInt8(s.UNLOAD_RESOURCE),r.writeUInt32(t.id)),t.state!==o.LOADING&&t.onUnload(),t.state=o.UNLOADED)},t}(),v=function(){function t(t){this.canvas=t,this.resources=new Map,this.gl=t.getContext("webgl2")}return t.prototype.getResource=function(t,r){var e=this.resources.get(t);if(!e)return null;if(!(e instanceof r))throw new Error("Resource has incorrect type!");return e},t.prototype.render=function(t){for(var r,n=this.resources,o=Array(256);(r=t.readUInt8())!==s.STOP;)if(r!==s.RUN_COMMAND)if(r!==s.MAP_COMMAND)if(r!==s.UPDATE_RESOURCE)if(r!==s.LOAD_RESOURCE)r!==s.UNLOAD_RESOURCE?r!==s.ADVANCE||t.advance():(u=t.readUInt32(),(f=this.resources.get(u)).unload(),this.resources.delete(u));else{u=t.readUInt32();var a=t.readString(),f=new i[a](this);n.set(u,f),f.load(t)}else{var u=t.readUInt32();(f=this.resources.get(u)).update(t)}else{u=t.readUInt8();var c=t.readString(),h=e[c];if(!h)throw new Error("Command "+c+" not registered");o[u]=h}else o[u=t.readUInt8()].render(t,this)},t}(),g=(y=function(t,r){return(y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])})(t,r)},function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function e(){this.constructor=t}y(t,r),t.prototype=null===r?Object.create(r):(e.prototype=r.prototype,new e)}),b=67305985===new Uint32Array(new Uint8Array([1,2,3,4]).buffer)[0],A=function(){function t(t){void 0===t&&(t=!1),this.shared=t,this.textEncoder=new TextEncoder}return t.prototype.writeString=function(t){var r=this.textEncoder.encode(t);this.writeUInt32(r.length),r.length>128?this.passData(r.buffer):this.writeUInt8Array(r)},t.prototype.writeFloat32=function(t){var r=this.allocate(4,4);this.writeView.setFloat32(r,t,b)},t.prototype.writeFloat64=function(t){var r=this.allocate(8,8);this.writeView.setFloat64(r,t,b)},t.prototype.writeInt8=function(t){var r=this.allocate(1,1);this.writeView.setInt8(r,t)},t.prototype.writeInt16=function(t){var r=this.allocate(2,2);this.writeView.setInt16(r,t,b)},t.prototype.writeInt32=function(t){var r=this.allocate(4,4);this.writeView.setInt32(r,t,b)},t.prototype.writeUInt8=function(t){var r=this.allocate(1,1);this.writeView.setUint8(r,t)},t.prototype.writeUInt16=function(t){var r=this.allocate(2,2);this.writeView.setUint16(r,t,b)},t.prototype.writeUInt32=function(t){var r=this.allocate(4,4);this.writeView.setUint32(r,t,b)},t.prototype.writeFloat32Array=function(t){for(var r=this.allocate(4*t.length,4),e=0,n=t.length;e<n;e++)this.writeView.setFloat32(r+4*e,t[e],b)},t.prototype.writeFloat64Array=function(t){for(var r=this.allocate(8*t.length,8),e=0,n=t.length;e<n;e++)this.writeView.setFloat64(r+8*e,t[e],b)},t.prototype.writeInt8Array=function(t){for(var r=this.allocate(t.length,1),e=0,n=t.length;e<n;e++)this.writeView.setInt8(r+e,t[e])},t.prototype.writeInt16Array=function(t){for(var r=this.allocate(2*t.length,2),e=0,n=t.length;e<n;e++)this.writeView.setInt16(r+2*e,t[e],b)},t.prototype.writeInt32Array=function(t){for(var r=this.allocate(4*t.length,4),e=0,n=t.length;e<n;e++)this.writeView.setInt32(r+4*e,t[e],b)},t.prototype.writeUInt8Array=function(t){for(var r=this.allocate(t.length,1),e=0,n=t.length;e<n;e++)this.writeView.setUint8(r+e,t[e])},t.prototype.writeUInt16Array=function(t){for(var r=this.allocate(2*t.length,2),e=0,n=t.length;e<n;e++)this.writeView.setUint16(r+2*e,t[e],b)},t.prototype.writeUInt32Array=function(t){for(var r=this.allocate(4*t.length,4),e=0,n=t.length;e<n;e++)this.writeView.setUint32(r+4*e,t[e],b)},t}(),m=function(){function t(t){void 0===t&&(t=!1),this.shared=t,this.textDecoder=new TextDecoder("utf8")}return t.prototype.readString=function(){var t,r=this.readUInt32();return t=r>128?this.getData():this.readUInt8Array(r),this.textDecoder.decode(t)},t.prototype.readFloat32=function(){var t=this.prepareRead(4,4);return this.readView.getFloat32(t,b)},t.prototype.readFloat64=function(){var t=this.prepareRead(8,8);return this.readView.getFloat64(t,b)},t.prototype.readInt8=function(){var t=this.prepareRead(1,1);return this.readView.getInt8(t)},t.prototype.readInt16=function(){var t=this.prepareRead(2,2);return this.readView.getInt16(t,b)},t.prototype.readInt32=function(){var t=this.prepareRead(4,4);return this.readView.getInt32(t,b)},t.prototype.readUInt8=function(){var t=this.prepareRead(1,1);return this.readView.getUint8(t)},t.prototype.readUInt16=function(){var t=this.prepareRead(2,2);return this.readView.getUint16(t,b)},t.prototype.readUInt32=function(){var t=this.prepareRead(4,4);return this.readView.getUint32(t,b)},t.prototype.readFloat32Array=function(t){var r=this.prepareRead(4*t,4);return new Float32Array(this.readBuffer,r,t)},t.prototype.readFloat64Array=function(t){var r=this.prepareRead(8*t,8);return new Float64Array(this.readBuffer,r,t)},t.prototype.readInt8Array=function(t){var r=this.prepareRead(t,1);return new Int8Array(this.readBuffer,r,t)},t.prototype.readInt16Array=function(t){var r=this.prepareRead(2*t,2);return new Int16Array(this.readBuffer,r,t)},t.prototype.readInt32Array=function(t){var r=this.prepareRead(4*t,4);return new Int32Array(this.readBuffer,r,t)},t.prototype.readUInt8Array=function(t){var r=this.prepareRead(t,1);return new Uint8Array(this.readBuffer,r,t)},t.prototype.readUInt16Array=function(t){var r=this.prepareRead(2*t,2);return new Uint16Array(this.readBuffer,r,t)},t.prototype.readUInt32Array=function(t){var r=this.prepareRead(4*t,4);return new Uint32Array(this.readBuffer,r,t)},t}(),O=function(){function t(){this.buffers=[],this.bufferIndex=-1}return t.prototype.allocate=function(t){if(this.bufferIndex++,this.bufferIndex===this.buffers.length){var r=new ArrayBuffer(Math.max(t,1024));return this.buffers.push(r),r}var e=this.buffers[this.bufferIndex];return e.byteLength<t&&(this.buffers.push(e),e=new ArrayBuffer(t),this.buffers[this.bufferIndex]=e),e},t.prototype.return=function(t){var r;(r=this.buffers).push.apply(r,function(t,r){for(var e=0,n=r.length,o=t.length;e<n;e++,o++)t[o]=r[e];return t}([],function(t,r){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var n,o,i=e.call(t),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(o)throw o.error}}return a}(t)))},t.prototype.reset=function(){this.buffers=[],this.bufferIndex=0},t}(),R=function(t){function r(r,e){void 0===r&&(r=!1),void 0===e&&(e=new O);var n=t.call(this,r)||this;return n.allocator=e,n.writeBuffers=[],n.writeOffset=0,n}return g(r,t),r.prototype.advance=function(){this.writeBuffer=null,this.writeView=null,this.writeOffset=0},r.prototype.passData=function(t){this.writeBuffers.push(t)},r.prototype.createWriter=function(){return new r(this.shared,this.allocator)},r.prototype.allocate=function(t,r){if(!this.writeBuffer)return this.writeBuffer=this.allocator.allocate(t),this.writeView=new DataView(this.writeBuffer),this.writeBuffers.push(this.writeBuffer),this.writeOffset=t,0;var e=this.writeOffset;r>1&&(e+=r-e%r);var n=e+t;return n>this.writeBuffer.byteLength?(this.advance(),this.allocate(t,r)):(this.writeOffset=n,e)},r.prototype.flush=function(){var t=this.writeBuffers;return this.writeBuffer=null,this.writeView=null,this.writeOffset=0,this.writeBuffers=[],t},r}(A),U=function(t){function r(){var r=null!==t&&t.apply(this,arguments)||this;return r.readBuffers=[],r.readBufferIndex=0,r.readOffset=0,r}return g(r,t),r.prototype.getData=function(){return this.readBuffers[++this.readBufferIndex]},r.prototype.advance=function(){this.readBuffer=this.readBuffers[++this.readBufferIndex],this.readView=new DataView(this.readBuffer),this.readOffset=0},r.prototype.prepareRead=function(t,r){var e=this.readOffset;r>1&&(e+=r-e%r);var n=e+t;return n>this.readBuffer.byteLength?(this.advance(),this.prepareRead(t,r)):(this.readOffset=n,e)},r.prototype.receive=function(t){var r=this.readBuffers;return this.readBuffers=t,this.readBufferIndex=0,this.readBuffer=t[0],this.readView=this.readBuffer?new DataView(this.readBuffer):null,this.readOffset=0,r},r}(m),I=function(){var t=function(r,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])})(r,e)};return function(r,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=r}t(r,e),r.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),S=function(t){function r(r){var e=t.call(this,D)||this;return e.buffer=r,e.updates=[],e.isShared=!1,window.SharedArrayBuffer&&(e.isShared=r instanceof SharedArrayBuffer),e.byteView=new Uint8Array(r),e.size=r.byteLength,e}return I(r,t),r.prototype.notify=function(t,r){this.updates.push({offset:t,length:r}),this.needsUpdate=!0},r.prototype.writeData=function(t){this.isShared||t.shared?(t.writeUInt8(1),t.passData(this.buffer)):(t.writeUInt8(0),t.writeUInt32(this.buffer.byteLength),t.writeUInt8Array(this.byteView))},r.prototype.writeUpdate=function(t){var r=this.updates;t.writeUInt32(r.length);for(var e=0;e<r.length;e++){var n=r[e],o=n.offset,i=n.length;t.writeUInt32(o),t.writeUInt32(i),(this.isShared||t.shared)&&t.writeUInt8Array(this.byteView.subarray(o,o+i))}this.updates=[]},r.prototype.onUnload=function(){this.needsUpdate=!1,this.updates=[]},r}(c),D=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return I(r,t),r.prototype.load=function(t){var r;if(t.readUInt8())this.sharedBuffer=r=new Uint8Array(t.getData());else{var e=t.readUInt32();r=t.readUInt8Array(e)}var n=this.renderer.gl,o=this.buffer=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,o),n.bufferData(n.ARRAY_BUFFER,r,n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null)},r.prototype.update=function(t){var r=this.renderer.gl;r.bindBuffer(r.ARRAY_BUFFER,this.buffer);for(var e=t.readUInt32(),n=0;n<e;n++){var o=t.readUInt32(),i=t.readUInt32();this.sharedBuffer?r.bufferSubData(r.ARRAY_BUFFER,o,t.readUInt8Array(i)):r.bufferSubData(r.ARRAY_BUFFER,o,this.sharedBuffer,o,i)}r.bindBuffer(r.ARRAY_BUFFER,null)},r.prototype.unload=function(){this.renderer.gl.deleteBuffer(this.buffer),this.buffer=null},r.resourceName="Buffer",r}(h),E=function(){var t=function(r,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])})(r,e)};return function(r,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=r}t(r,e),r.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),B=function(t,r){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var n,o,i=e.call(t),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(o)throw o.error}}return a},_="#version 300 es\nprecision highp float;\n",x=function(t){function r(r){var e=t.call(this,P)||this;return e.def=r,e}return E(r,t),r.prototype.writeData=function(t){t.writeString(JSON.stringify(this.def))},r}(c),P=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return E(r,t),r.prototype.load=function(t){var r=JSON.parse(t.readString()),e=this.renderer.gl,n=r.attributes||{},o=r.uniforms||{},i=function(t,r,e){return _+function(t){return Object.entries(t).map((function(t){return"in "+t[1]+" "+t[0]+";"})).join("\n")+"\n"}(r)+C(e)+T(t)}(r.vertexShader,n,o),a=function(t,r){return _+C(r)+T(t)}(r.fragmentShader,o),f=this.vertexShader=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(f,i),e.compileShader(f),!e.getShaderParameter(f,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(f));var u=this.fragmentShader=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(u,a),e.compileShader(u),!e.getShaderParameter(u,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(u));var s=this.program=e.createProgram();if(e.attachShader(s,f),e.attachShader(s,u),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(s));this.attributes=Object.entries(n).map((function(t){var r=B(t,2),n=r[0];return{name:n,type:r[1],location:e.getAttribLocation(s,n)}})),this.uniforms=Object.entries(o).map((function(t){var r=B(t,2),n=r[0];return{name:n,type:r[1],location:e.getUniformLocation(s,n)}}))},r.prototype.update=function(){},r.prototype.unload=function(){var t=this.renderer.gl;t.deleteProgram(this.program),t.deleteShader(this.vertexShader),t.deleteShader(this.fragmentShader),this.program=void 0,this.vertexShader=void 0,this.fragmentShader=void 0},r.resourceName="Program",r}(h);function C(t){return Object.entries(t).map((function(t){return"uniform "+t[1]+" "+t[0]+";"})).join("\n")+"\n"}var L=/[^ \t]/;function T(t){var r,e,n=t.split("\n"),o=1/0;try{for(var i=function(t){var r="function"==typeof Symbol&&Symbol.iterator,e=r&&t[r],n=0;if(e)return e.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}(n),a=i.next();!a.done;a=i.next()){var f=a.value,u=f.match(L),s=u?u.index:f.length;o=Math.min(o,s)}}catch(t){r={error:t}}finally{try{a&&!a.done&&(e=i.return)&&e.call(i)}finally{if(r)throw r.error}}return n.map((function(t){return t.slice(o)})).join("\n")}var N,V=n({name:"RunProgram",submit:function(t,r,e){var n=e.program,o=e.buffer,i=e.offset,a=e.length;t.loadResource(n),t.loadResource(o),r.writeUInt32Array([n.id,o.id,i,a])},render:function(t,r){var e=function(t,r){var e="function"==typeof Symbol&&t[Symbol.iterator];if(!e)return t;var n,o,i=e.call(t),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(o)throw o.error}}return a}(t.readUInt32Array(4),4),n=e[0],o=e[1],i=(e[2],e[3],r.getResource(n,P)),a=r.getResource(o,D);console.log(i,a)}}),M=new x({attributes:{color:"vec4",position:"vec4"},vertexShader:"\n        out vec4 vColor;\n\n        void main() {\n            vColor = color;\n            gl_Position = position;\n        }\n    ",fragmentShader:"\n        in vec4 vColor;\n         \n        out vec4 outColor;\n         \n        void main() {\n          outColor = vColor;\n        }\n    "}),j=function(){function t(t){this.context=t,this.zIndex=0,this.drawCallBatcher=new F}return t.prototype.submit=function(t){this.drawCallBatcher.submit(t)},t.prototype.rect=function(t,r,e,n){var o=this.zIndex++;this.triangles([t,r,o,t+e,r,o,t+e,r+n,o,t,r,o,t+e,r+n,o,t,r+n,o])},t.prototype.triangles=function(t){this.drawCallBatcher.drawTriangles(this.context,M,t)},t}(),F=function(){function t(){this.programs={},this.batchedPrograms=[]}return t.prototype.drawTriangles=function(t,r,e){var n=t.id+":"+r.id,o=this.programs[n];o?(o.triangles.push(e),o.trianglesLength+=e.length):this.programs[n]={context:t,program:r,triangles:[e],trianglesLength:e.length}},t.prototype.submit=function(t){var r,e;try{for(var n=function(t){var r="function"==typeof Symbol&&Symbol.iterator,e=r&&t[r],n=0;if(e)return e.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}(Object.values(this.programs)),o=n.next();!o.done;o=n.next()){var i=o.value,a=i.context,f=i.program,u=i.triangles,s=i.trianglesLength,c=a.float32BufferPool.writeMultiData(u,s),h=c.buffer,l=c.byteOffset;t.command(V,{program:f,buffer:h,offset:l,length:s})}}catch(t){r={error:t}}finally{try{o&&!o.done&&(e=n.return)&&e.call(n)}finally{if(r)throw r.error}}},t}(),Y=0;!function(t){t.nextID=function(){return Y++}}(N||(N={}));var W=function(){this.id=N.nextID(),this.bufferPool=new z(this),this.float32BufferPool=new G(this.bufferPool,Float32Array)},G=function(){function t(t,r){this.pool=t,this.type=r}return t.prototype.writeMultiData=function(t,r){var e=this.type.BYTES_PER_ELEMENT,n=r*e,o=this.pool.allocateSpace(n),i=this.pool.currentBuffer;this.currentBuffer!==i&&(this.currentBuffer=i,this.currentView=new this.type(i.buffer));for(var a=o,f=0;f<t.length;f++){var u=t[f];this.currentView.set(u,a),a+=u.length*e}return{buffer:i,byteOffset:o,byteLength:n}},t.prototype.writeData=function(t){var r=this.type.BYTES_PER_ELEMENT,e=t.length*r,n=this.pool.allocateSpace(e),o=this.pool.currentBuffer;return this.currentBuffer!==o&&(this.currentBuffer=o,this.currentView=new this.type(o.buffer)),this.currentView.set(t,n),{buffer:o,byteOffset:n,byteLength:e}},t}(),z=function(){function t(t){this.context=t,this.buffers=[],this.buffersIndex=0,this.currentBufferOffset=0}return t.prototype.reset=function(){this.buffersIndex=0,this.currentBufferOffset=0},t.prototype.allocateSpace=function(t){this.buffersIndex>=this.buffers.length&&(this.currentBuffer=new S(new ArrayBuffer(Math.max(1024,t))),this.buffers.push(this.currentBuffer));var r=this.currentBufferOffset+t;if(r>this.currentBuffer.size){if(0!==this.currentBufferOffset)return this.buffersIndex++,this.currentBufferOffset=0,this.currentBuffer=this.buffers[this.buffersIndex],this.allocateSpace(t);this.currentBuffer=new S(new ArrayBuffer(Math.max(1024,t))),this.buffers[this.buffersIndex]=this.currentBuffer}var e=this.currentBufferOffset;return this.currentBufferOffset=r,e},t}(),k=function(){var t=function(r,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])})(r,e)};return function(r,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=r}t(r,e),r.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),H=function(t){var r="function"==typeof Symbol&&Symbol.iterator,e=r&&t[r],n=0;if(e)return e.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},J=function(t){function r(r){var e=t.call(this)||this;return e.fn=r,e.resources=new Set,e.renderTarget=new j(e),e}return k(r,t),r.prototype.render=function(t){var r,e;this.fn(this.renderTarget);var n=new w(t);this.renderTarget.submit(n);try{for(var o=H(n.resources),i=o.next();!i.done;i=o.next()){var a=i.value;a.refcount++,this.resources.add(a)}}catch(t){r={error:t}}finally{try{i&&!i.done&&(e=o.return)&&e.call(o)}finally{if(r)throw r.error}}n.finish()},r.prototype.unload=function(t){var r,e,n=new w(t);try{for(var o=H(this.resources),i=o.next();!i.done;i=o.next()){var a=i.value;a.refcount--,n.unloadResource(a)}}catch(t){r={error:t}}finally{try{i&&!i.done&&(e=o.return)&&e.call(o)}finally{if(r)throw r.error}}n.finish()},r}(W),K=function(){var t=function(r,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])})(r,e)};return function(r,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=r}t(r,e),r.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),X=function(t){function r(){var r=null!==t&&t.apply(this,arguments)||this;return r.protocolWriter=new R(!0),r.protocolReader=new U(!0),r}return K(r,t),r.prototype.renderComponent=function(t){t.render(this.protocolWriter);var r=this.protocolWriter.flush();this.protocolReader.receive(r),this.render(this.protocolReader)},r.prototype.unloadComponent=function(t){t.unload(this.protocolWriter);var r=this.protocolWriter.flush();this.protocolReader.receive(r),this.render(this.protocolReader)},r}(v);return a(P),a(D),r})()}));
//# sourceMappingURL=rendercrank.production.js.map