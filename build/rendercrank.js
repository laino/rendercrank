!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RenderCrank=e():t.RenderCrank=e()}(self,(function(){return(()=>{"use strict";var t,e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};e.r(r),e.d(r,{RenderContext:()=>c,Renderer:()=>s,Resource:()=>o,ResourceState:()=>t,Scene:()=>f}),function(t){t[t.UNLOADED=0]="UNLOADED",t[t.LOADING=1]="LOADING",t[t.LOADED=2]="LOADED",t[t.UNLOADING=3]="UNLOADING"}(t||(t={}));var n,o=function(){function e(e){this.renderer=e,this.state=t.UNLOADED}return Object.defineProperty(e.prototype,"loaded",{get:function(){return this.state===t.LOADED},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loading",{get:function(){return this.state===t.LOADING||this.state===t.UNLOADING},enumerable:!1,configurable:!0}),e.prototype.ref=function(){return this.refcount++,this._load()},e.prototype.unref=function(){if(this.refcount--,this.refcount<0)throw new Error("refcount < 0");return this._unload()},e.prototype._load=function(){var e=this;if(this.state!==t.UNLOADED)return this.loadPromise;this.state=t.LOADING;var r=this.load();r?this.loadPromise=r.then((function(){e.loadPromise=void 0,e.state=t.LOADED,0===e.refcount&&e._unload()})):this.state=t.LOADED},e.prototype._unload=function(){var e=this;if(this.state!==t.LOADED||this.refcount>0)return this.unloadPromise;this.state=t.UNLOADING;var r=this.unload();if(r)return this.unloadPromise=r.then((function(){e.unloadPromise=void 0,e.state=t.UNLOADED,e.refcount>0&&e._load()}));this.state=t.UNLOADED},e}(),i=(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),u=Promise.resolve(),c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.resources=new Set,e}return i(e,t),e.prototype.load=function(){return t=this,e=void 0,n=function(){return function(t,e){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=e.call(t,u)}catch(t){i=[6,t],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}(this,(function(t){return[2]}))},new((r=void 0)||(r=Promise))((function(o,i){function u(t){try{s(n.next(t))}catch(t){i(t)}}function c(t){try{s(n.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(u,c)}s((n=n.apply(t,e||[])).next())}));var t,e,r,n},e.prototype.unload=function(){return this.removeAllResources()},e.prototype.addResource=function(t){return this.resources.add(t)?t.ref():u},e.prototype.removeResource=function(t){return this.resources.delete(t)?t.unref():u},e.prototype.removeAllResources=function(){var t=this;return new Promise((function(e,r){var n,o,i=t.resources.size;function u(){0==--i&&e(void 0)}try{for(var c=function(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(t.resources),s=c.next();!s.done;s=c.next()){var a=s.value.unref();a?a.then(u,r):u()}}catch(t){n={error:t}}finally{try{s&&!s.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}}))},e}(o),s=function(){this.context=new c(this)},a=function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),f=function(t){function e(e,r){var n=t.call(this,e)||this;return n.fn=r,n}return a(e,t),e.prototype.render=function(){return this.renderer.context.addResource(this),this.fn(this.context)},e}(c);return r})()}));